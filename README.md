# TLGRM - комбинированный скрипт оповещения в Телеграм и удалённого запуска функций, скриптов и команд RouterOS.

В скрипте использованы идеи и части кода разных авторов

Для работы скрипта должны быть заранее известны и указаны BotID и ChatID (https://1spla.ru/blog/telegram_bot_for_mikrotik/).
Скрипт необходимо добавить в System/Scripts или System/Sheduler и установить запуск с нужной периодичностью.

Работа скрипта состоит из двух задач:

1. Слушатель ТГ-группы + парсер команд

2. Анализатор и транслятор сообщений Mikrotik в ТГ-группу

Для отправки команды конкретному роутеру в Телеграм-группе, необходимо сформировать текстовое сообщение. Начало сообщения обозначается символом "/" с последующим указанием имени роутера (должно соответствовать записи в /system identity и не должно содержать пробелов), далее через подчеркивание пишется команда. Для отправки команды всем роутерам в Телеграм-группе вместо имени указывается 'forall'.
В качестве команды могут выступать: имя глобальной функции, имя скрипта или команда RouterOS. Например:

    /forall log warning [/system identity get name]
    /Mikrotik1 wol
    /MikroTik system reboot

Дополнительно можно настроить локальные флаги в начале скрипта, которые указывают разрешено ли распознавание и выполнение скриптом скриптов, функций и/или прямых команд ROS соответственно (по умолчанию все данные опции разрешены). Если какие-то функции не нужны, установите соответствующие флаги в false:

    :local launchScr true;
    :local launchFnc true;
    :local launchCmd true;

Особенности работы скрипта:
 - поддерживается отправка сообщений в Телеграм-группу с кириллицей (CP1251)
 - отправляемое в Телеграм-группу сообщение обрезается до 4096 знаков
 - скрипт "слушет" ПОСЛЕДНЕЕ сообщение в Телеграм-группе, по этой причине не имеет смысла накидывать сразу много команд, в любом случае будет выполнена только последняя.
 - поддерживается индивидуальная и групповая адресация команд
 - при запуске скрипта в терминале можно наблюдать за ходом его выполнения

---------------------------------------------------------------------------------------
Последовательность действий для формирования списка команд в Телеграм-группе через бота BotFather.
Дальнейшее взаимодействие производим с BotFather:
вводим и отправляем команду: /setcommands
выбираем нужного бота
выскочит подсказка:
CODE: SELECT ALL

        command1 - Description
        command2 - Another description
По сути это шаблон с указанием формата ввода команд, в котором:
каждая команда должна быть оформлена отдельной строкой.
в каждой строке слева от дефиса должен находиться текст с командой. Этот текст в дальнейшем и будет отправляться при выборе команды.
в каждой строке справа от дефиса пишется краткое описание команды. Оно нужно для того, чтобы не держать в голове все команды. Описание поможет вспомнить, что это за команда и что она делает.
Следует обратить внимание на важные детали при формировании текстовых строк с командами:
текст команды (слева от дефиса) может состоять ТОЛЬКО из цифр, маленьких латинских букв и знака подчёркивания (заглавные буквы, пробелы, спецсимволы и кириллица недопустимы).
текст описания (справа от дефиса) может содержать любые символы. Текст обязательно должен быть.
при добавлении новых команд, старые команды нужно вбивать вновь... Другими словами: все команды нужно вводить одним списком.
теперь вводим и отправляем команду по шаблону: имямикротик_имяскрипта - текст с описанием
Если всё сделано правильно, получим ответ: 'Success! Command list updated.'

Обратите внимание! В "команду" мы на самом деле запихиваем 'имямикротик' и 'имяскрипта' через символ подчёркивания. Это делается чтобы BotFather не ругался и проглотил эту "команду", в которой на самом деле зашифровано имя роутера с названием скрипта, которые в свою очередь должны быть обработаны TLGRM. А т.к. для наших целей пробелы нужны как минимум для отделения ID маршрутизатора от команды, пришлось заниматься самообманом: отныне скрипт считает пробелы (' ') и знаки подчёркивания ('_') тождественными. Таким образом BotFather тянет за собой зависимость -> ID роутеров и названия скриптов могут состоять только из цифр и маленьких латинских букв (заглавные буквы, пробелы, знаки подчёркивания, спецсимволы и кириллица недопустимы!!!).
теперь, нажав на кнопку "/" в своём чате с ботом, можно посмотреть, какие команды (скрипты) и на каких устройствах нам доступны, а при желании можно выбрать нужную команду и отправить её на исполнение.
---------------------------------------------------------------------------------------

Для корректного отображения скриптом 'username' отправителя, в настройках Телеграм должно быть заполнено поле "Имя пользователя", бот должен быть подключен к ГРУППЕ (групповому чату), а не к КАНАЛУ.

Опытным путём выяснено, что предпочтителен групповой чат Телеграм с id БЕЗ префикса '-100', в таком чате сообщения от ГРУППЫ роутеров не теряются.

https://forummikrotik.ru/viewtopic.php?p=89956#p89956

https://habr.com/ru/post/650563/
