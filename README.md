# TLGRM - комбинированный скрипт оповещения в Телеграм и удалённого запуска функций, скриптов и команд RouterOS.

В скрипте использованы идеи и части кода разных авторов

Для работы скрипта должны быть заранее известны и указаны BotID и ChatID (https://1spla.ru/blog/telegram_bot_for_mikrotik/).
Скрипт необходимо добавить в System/Scripts или System/Sheduler и установить запуск с нужной периодичностью.

Работа скрипта состоит из двух задач:

1. Слушатель ТГ-группы + парсер команд

2. Анализатор и транслятор сообщений Mikrotik в ТГ-группу

Для отправки команды конкретному роутеру в Телеграм-группе, необходимо сформировать текстовое сообщение. Начало сообщения обозначается символом "/" с роледующим указанием имени роутера (должно соответствовать записи в /system identity, при этом регистр букв имеет значение и не должно содержать пробелов), далее через пробел или подчеркивание пишется команда. Для отправки команды всем роутерам в Телеграм-группе вместо имени указывается 'forall'.
В качестве команды могут выступать: имя глобальной функции, имя скрипта или команда RouterOS. Например:

    /forall log warning [/system identity get name]
    /Mikrotik1 wol
    /MikroTik system reboot

Дополнительно можно настроить локальные флаги в начале скрипта, которые указывают разрешено ли распознавание и выполнение скриптом скриптов, функций и/или прямых команд ROS соответственно (по умолчанию все данные опции разрешены). Если какие-то функции не нужны, установите соответствующие флаги в false:

    :local launchScr true;
    :local launchFnc true;
    :local launchCmd true;

Особенности работы скрипта:
 - поддерживается отправка сообщений в Телеграм-группу с кириллицей
 - сообщение длиной более 4096 перед отправкой в Телеграм-группу обрезается до 4096 символов
 - скрипт читает только ПОСЛЕДНЕЕ сообщение в Телеграм-группе. По этой причине не имеет смысла накидывать сразу много команд, в любом случае будет выполнена только последняя.
 - поддерживается индивидуальная и групповая адресация команд
 - при запуске скрипта в терминале можно наблюдать за ходом его выполнения

Для корректного отображения скриптом 'username' отправителя, в настройках Телеграм должно быть заполнено поле "Имя пользователя", бот должен быть подключен к ГРУППЕ (групповому чату), а не к КАНАЛУ.

Опытным путём выяснено, что предпочтителен групповой чат Телеграм с id БЕЗ префикса '-100', в таком чате сообщения от ГРУППЫ роутеров не теряются.

https://forummikrotik.ru/viewtopic.php?p=83858#p83858

https://habr.com/ru/post/650563/
